<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>subtitle timestamps</title>
  <link rel="stylesheet" href="subtitle-timestamps.css">
  <script src="https://code.jquery.com/jquery-3.7.1.slim.min.js"></script>
</head>
<body>

<label for="file">Open SRT file:</label>
<input type="file" id="file" accept=".srt"><!-- TODO: ".srt,.vtt" -->
<table>
  <thead>
    <tr>
      <th class="time">Start</th>
      <th class="time">End</th>
      <th>Text</th>
    </tr>
  </thead>
  <tbody id="tbody"/>
</table>
<button id="download">Download modified file</button>

<script>
let entries = [];
let filename = '';

$('#file').on('change', event => {
  const file = event.target.files[0];
  filename = file.name;
  file.text().then(content => {
    parseEntries(content);
    const tbody = $('#tbody');
    tbody.empty();
    for (const entry of entries) {
      tbody.append(
        $('<tr>').append([
          $('<td>', {class: 'time'}).text(formatTime(entry.start)),
          $('<td>', {class: 'time'}).text(formatTime(entry.end)),
          $('<td>').text(entry.text.join(' / '))
        ])
      );
    }
  });
});

$('#download').on('click', () => {
  if (entries.length === 0) return;
  const content = formatEntries();
  const blob = new Blob([content], {type: 'text/plain'});
  const url = URL.createObjectURL(blob);
  const a = $('<a>')
    .attr('href', url)
    .attr('download', modifiedFilename())
    .css('display', 'none')
    .appendTo('body');
  a[0].click();
  a.remove();
  URL.revokeObjectURL(url);
});

function modifiedFilename() {
  const dot = filename.lastIndexOf('.');
  return filename.substring(0, dot) + '_modified' + filename.substring(dot);
}

function parseEntries(text) {
  entries = [];
  // TODO: support .vtt
  // TODO: support \r\n and \r
  const blocks = text.trim().split('\n\n');
  for (const block of blocks) {
    const lines = block.split('\n');
    const times = lines[1].split(' --> ');
    const start = parseTime(times[0]);
    const end = parseTime(times[1]);
    const text = lines.slice(2);
    entries.push({start, end, text});
  }
}

function formatEntries() {
  // TODO: support \r\n and \r
  let result = '';
  let index = 0;
  for (const entry of entries) {
    if (index > 0) result += '\n';
    result += ++index + '\n';
    result += formatTime(entry.start) + ' --> ' + formatTime(entry.end) + '\n';
    for (const line of entry.text) result += line + '\n';
  }
  return result;
}

function parseTime(time) {
  return new Date('1970-01-01T' + time.replace(',', '.') + 'Z');
}

function formatTime(date) {
  return date.toISOString().substring(11, 23).replace('.', ',');
}
</script>

</body>
</html>