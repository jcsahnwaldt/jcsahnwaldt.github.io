<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>subtitle timestamps</title>
  <link rel="stylesheet" href="subtitle-timestamps.css">
  <script src="https://code.jquery.com/jquery-3.7.1.slim.min.js"></script>
</head>
<body>

<label for="file">Load file:</label>
<input id="load" type="file" accept=".srt"><!-- TODO: ".srt,.vtt" -->

<table>
  <thead>
    <tr>
      <th class="time">Start</th>
      <th class="time">End</th>
      <th>Text</th>
    </tr>
  </thead>
  <tbody id="tbody-original"/>
</table>

<form id="form">
  <label for="modify">Modify file:</label>
  <button id="modify">Modify</button>
  <label for="factor">Factor:</label>
  <input id="factor" type="text" value="1.0" placeholder="1.0" pattern="\s*\d\d?(\.\d*)?\s*" required>
  <label for="offset">Offset:</label>
  <input id="offset" type="text" value="00:00:00,000" pattern="\s*-?(2[0-3]|[01]\d):[0-5]\d:[0-5]\d,\d{3}\s*" placeholder="(-)hh:mm:ss,mmm" required>
</form>

<table>
  <thead>
    <tr>
      <th class="time">Start</th>
      <th class="time">End</th>
      <th>Text</th>
    </tr>
  </thead>
  <tbody id="tbody-modified"/>
</table>

<label for="save">Save file:</label>
<button id="save">Save</button>

<script>
let entries = [];
let filename = '';
let factor = 1.0;
let offset = 0;

$('#load').on('change', event => {
  const file = event.target.files[0];
  filename = file.name;
  file.text().then(content => {
    parseEntries(content);
    fillTable('#tbody-original', false);
    fillTable('#tbody-modified', true);
  });
});

$('#form').on('submit', event => {
  event.preventDefault();
  fillTable('#tbody-modified', true);
});

$('#save').on('click', event => {
  if (entries.length === 0) return;
  const content = formatEntries(true);
  const blob = new Blob([content], {type: 'text/plain'});
  const url = URL.createObjectURL(blob);
  const a = $('<a>')
    .attr('href', url)
    .attr('download', modifiedFilename())
    .css('display', 'none')
    .appendTo('body');
  a[0].click();
  a.remove();
  URL.revokeObjectURL(url);
});

function modifiedFilename() {
  const dot = filename.lastIndexOf('.');
  return filename.substring(0, dot) + '_modified' + filename.substring(dot);
}

function parseEntries(text) {
  entries = [];
  // TODO: support .vtt: https://w3c.github.io/webvtt/
  // TODO: support \r\n and \r
  const blocks = text.trim().split(/\n\n+/);
  for (const block of blocks) {
    const lines = block.split('\n');
    const times = lines[1].split(' --> ');
    const start = parseTime(times[0]);
    const end = parseTime(times[1]);
    const text = lines.slice(2);
    entries.push({start, end, text});
  }
}

function fillTable(tbodyId, modify = false) {
  if (modify) parseParams();
  const tbody = $(tbodyId);
  tbody.empty();
  for (const e of entries) {
    tbody.append(
      $('<tr>').append([
        $('<td>').addClass('time').text(formatTime(e.start, modify)),
        $('<td>').addClass('time').text(formatTime(e.end, modify)),
        $('<td>').text(e.text.join(' / '))
      ])
    );
  }
}

function parseParams() {
  let input = $('#factor');
  factor = input[0].validity.valid ? Number(input.val().trim()) : 1.0;
  input = $('#offset');
  offset = input[0].validity.valid ? parseOffset(input.val().trim()) : 0;
}

function formatEntries(modify = false) {
  // TODO: support \r\n and \r
  let result = '';
  let index = 0;
  for (const e of entries) {
    if (index > 0) result += '\n';
    result += ++index + '\n';
    result += formatTime(e.start, modify) + ' --> ' + formatTime(e.end, modify) + '\n';
    for (const line of e.text) result += line + '\n';
  }
  return result;
}

function parseOffset(offset) {
  return offset.startsWith('-') ? - parseTime(offset.substring(1)) : parseTime(offset);
}

function parseTime(time) {
  return Date.parse('1970-01-01T' + time.replace(',', '.') + 'Z');
}

function formatTime(time, modify = false) {
  const date = new Date(modify ? time * factor + offset : time);
  return date.toISOString().substring(11, 23).replace('.', ',');
}
</script>

</body>
</html>